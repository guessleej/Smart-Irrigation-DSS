# 程式規格書

**農業部農田水利署 115 年度「健全智慧管理模組及大數據資料庫」採購案**

**農業水資源智慧決策支援系統**

---

| 項目 | 內容 |
|------|------|
| 文件編號 | SIDSS-PS-001 |
| 版本 | 1.0 |
| 建立日期 | 2026 年 1 月 12 日 |
| 承辦廠商 | 云昱科技股份有限公司 |

---

## 1. 文件說明

### 1.1 文件目的

本程式規格書旨在詳細描述農業水資源智慧決策支援系統（SIDSS）之程式架構、模組設計、資料庫結構、API 規格等技術細節，作為系統維護與擴充之參考依據。

### 1.2 技術架構概述

本系統採用現代化的前後端分離架構，技術堆疊如下：

| 層級 | 技術選型 | 版本 |
|------|---------|------|
| 前端框架 | React | 19.2.1 |
| 前端語言 | TypeScript | 5.9.3 |
| UI 元件庫 | shadcn/ui + Radix UI | 最新版 |
| CSS 框架 | Tailwind CSS | 4.1.14 |
| 後端框架 | Express | 4.21.2 |
| API 框架 | tRPC | 11.6.0 |
| ORM | Drizzle ORM | 0.44.5 |
| 資料庫 | MySQL 8.0 / TiDB | 8.0+ |
| 執行環境 | Node.js | 22.13.0 |

---

## 2. 資料庫設計

### 2.1 實體關聯圖（ERD）

```
┌─────────────────┐     ┌─────────────────┐
│     users       │     │   reservoirs    │
├─────────────────┤     ├─────────────────┤
│ id (PK)         │     │ id (PK)         │
│ openId          │     │ name            │
│ name            │     │ code            │
│ email           │     │ latitude        │
│ role            │     │ longitude       │
│ createdAt       │     │ effectiveCapacity│
│ updatedAt       │     │ currentStorage  │
│ lastSignedIn    │     │ storagePercentage│
└─────────────────┘     │ waterLevel      │
                        │ inflow          │
                        │ outflow         │
                        │ status          │
                        │ dataTime        │
                        │ createdAt       │
                        │ updatedAt       │
                        └─────────────────┘

┌─────────────────┐     ┌─────────────────────┐
│rainfall_stations│     │irrigation_districts │
├─────────────────┤     ├─────────────────────┤
│ id (PK)         │     │ id (PK)             │
│ name            │     │ name                │
│ code            │     │ code                │
│ latitude        │     │ area                │
│ longitude       │     │ mainCrops           │
│ hourlyRainfall  │     │ waterSource         │
│ dailyRainfall   │     │ managementUnit      │
│ dataTime        │     │ latitude            │
│ createdAt       │     │ longitude           │
│ updatedAt       │     │ createdAt           │
└─────────────────┘     │ updatedAt           │
                        └─────────────────────┘

┌─────────────────────┐     ┌─────────────────────────────┐
│irrigation_facilities│     │      risk_assessments       │
├─────────────────────┤     ├─────────────────────────────┤
│ id (PK)             │     │ id (PK)                     │
│ districtId (FK)     │◄────│ districtId (FK)             │
│ name                │     │ riskIndex                   │
│ type                │     │ riskLevel                   │
│ latitude            │     │ reservoirStorageFactor      │
│ longitude           │     │ rainfallFactor              │
│ capacity            │     │ irrigationDemandFactor      │
│ status              │     │ recommendation              │
│ installDate         │     │ assessedAt                  │
│ createdAt           │     │ createdAt                   │
│ updatedAt           │     └─────────────────────────────┘
└─────────────────────┘

┌─────────────────────────────────┐     ┌─────────────────┐
│  water_allocation_simulations   │     │  data_sync_logs │
├─────────────────────────────────┤     ├─────────────────┤
│ id (PK)                         │     │ id (PK)         │
│ scenario                        │     │ dataType        │
│ totalWaterAvailable             │     │ source          │
│ allocations (JSON)              │     │ recordsCount    │
│ efficiency                      │     │ status          │
│ simulatedAt                     │     │ errorMessage    │
│ createdAt                       │     │ syncedAt        │
└─────────────────────────────────┘     │ createdAt       │
                                        └─────────────────┘
```

### 2.2 資料表定義

#### 2.2.1 users（使用者）

| 欄位名稱 | 資料型態 | 限制 | 說明 |
|---------|---------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主鍵 |
| openId | VARCHAR(64) | UNIQUE, NOT NULL | OAuth 識別碼 |
| name | TEXT | | 使用者名稱 |
| email | VARCHAR(320) | | 電子郵件 |
| loginMethod | VARCHAR(64) | | 登入方式 |
| role | ENUM('user','admin') | DEFAULT 'user' | 角色 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 建立時間 |
| updatedAt | TIMESTAMP | ON UPDATE NOW() | 更新時間 |
| lastSignedIn | TIMESTAMP | | 最後登入時間 |

#### 2.2.2 reservoirs（水庫）

| 欄位名稱 | 資料型態 | 限制 | 說明 |
|---------|---------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主鍵 |
| name | VARCHAR(100) | NOT NULL | 水庫名稱 |
| code | VARCHAR(20) | UNIQUE | 水庫代碼 |
| latitude | DECIMAL(10,7) | | 緯度 |
| longitude | DECIMAL(10,7) | | 經度 |
| effectiveCapacity | DECIMAL(15,2) | | 有效容量（萬m³） |
| currentStorage | DECIMAL(15,2) | | 目前蓄水量（萬m³） |
| storagePercentage | DECIMAL(5,2) | | 蓄水率（%） |
| waterLevel | DECIMAL(10,2) | | 水位（m） |
| inflow | DECIMAL(10,2) | | 進水量（m³/s） |
| outflow | DECIMAL(10,2) | | 出水量（m³/s） |
| status | ENUM | DEFAULT 'normal' | 狀態 |
| dataTime | TIMESTAMP | | 資料時間 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 建立時間 |
| updatedAt | TIMESTAMP | ON UPDATE NOW() | 更新時間 |

#### 2.2.3 rainfall_stations（雨量站）

| 欄位名稱 | 資料型態 | 限制 | 說明 |
|---------|---------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主鍵 |
| name | VARCHAR(100) | NOT NULL | 站名 |
| code | VARCHAR(20) | UNIQUE | 站碼 |
| latitude | DECIMAL(10,7) | | 緯度 |
| longitude | DECIMAL(10,7) | | 經度 |
| hourlyRainfall | DECIMAL(10,2) | | 時雨量（mm） |
| dailyRainfall | DECIMAL(10,2) | | 日累積雨量（mm） |
| dataTime | TIMESTAMP | | 資料時間 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 建立時間 |
| updatedAt | TIMESTAMP | ON UPDATE NOW() | 更新時間 |

#### 2.2.4 irrigation_districts（灌區）

| 欄位名稱 | 資料型態 | 限制 | 說明 |
|---------|---------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主鍵 |
| name | VARCHAR(100) | NOT NULL | 灌區名稱 |
| code | VARCHAR(20) | UNIQUE | 灌區代碼 |
| area | DECIMAL(15,2) | | 面積（公頃） |
| mainCrops | TEXT | | 主要作物 |
| waterSource | VARCHAR(200) | | 水源 |
| managementUnit | VARCHAR(100) | | 管理單位 |
| latitude | DECIMAL(10,7) | | 中心緯度 |
| longitude | DECIMAL(10,7) | | 中心經度 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 建立時間 |
| updatedAt | TIMESTAMP | ON UPDATE NOW() | 更新時間 |

#### 2.2.5 risk_assessments（風險評估）

| 欄位名稱 | 資料型態 | 限制 | 說明 |
|---------|---------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主鍵 |
| districtId | INT | FK | 灌區 ID |
| riskIndex | DECIMAL(5,2) | | 風險指數（0-100） |
| riskLevel | ENUM | | 風險等級 |
| reservoirStorageFactor | DECIMAL(5,2) | | 水庫蓄水因子 |
| rainfallFactor | DECIMAL(5,2) | | 降雨因子 |
| irrigationDemandFactor | DECIMAL(5,2) | | 灌溉需求因子 |
| recommendation | TEXT | | 建議措施 |
| assessedAt | TIMESTAMP | | 評估時間 |
| createdAt | TIMESTAMP | DEFAULT NOW() | 建立時間 |

---

## 3. API 規格

### 3.1 API 架構

系統採用 tRPC 框架建立型別安全的 API，所有 API 端點位於 `/api/trpc` 路徑下。

### 3.2 認證機制

| 項目 | 說明 |
|------|------|
| 認證方式 | OAuth 2.0 + JWT |
| Token 位置 | HTTP-only Cookie |
| Token 有效期 | 24 小時 |

### 3.3 API 端點規格

#### 3.3.1 Dashboard Router

**dashboard.getStats**

| 項目 | 說明 |
|------|------|
| 方法 | Query |
| 權限 | Public |
| 說明 | 取得儀表板統計資料 |

回應格式：

```typescript
{
  reservoirCount: number;
  averageStoragePercentage: number;
  alertReservoirCount: number;
  severeAlertReservoirCount: number;
  rainfallStationCount: number;
  averageHourlyRainfall: number;
  irrigationDistrictCount: number;
  totalIrrigationArea: number;
  recentRiskAssessments: RiskAssessment[];
  reservoirTrend: { date: string; value: number }[];
  rainfallTrend: { date: string; value: number }[];
}
```

#### 3.3.2 Reservoir Router

**reservoir.list**

| 項目 | 說明 |
|------|------|
| 方法 | Query |
| 權限 | Public |
| 說明 | 取得水庫清單 |

**reservoir.getRealtimeData**

| 項目 | 說明 |
|------|------|
| 方法 | Query |
| 權限 | Public |
| 說明 | 取得即時水庫資料（從外部 API） |

回應格式：

```typescript
{
  id: number;
  name: string;
  code: string;
  latitude: number;
  longitude: number;
  effectiveCapacity: number;
  currentStorage: number;
  storagePercentage: number;
  waterLevel: number;
  inflow: number;
  outflow: number;
  status: 'normal' | 'warning' | 'critical';
  dataTime: Date;
}[]
```

**reservoir.syncFromApi**

| 項目 | 說明 |
|------|------|
| 方法 | Mutation |
| 權限 | Protected |
| 說明 | 同步外部 API 資料至資料庫 |

#### 3.3.3 Risk Assessment Router

**riskAssessment.getLatest**

| 項目 | 說明 |
|------|------|
| 方法 | Query |
| 權限 | Public |
| 說明 | 取得最新風險評估結果 |

**riskAssessment.calculate**

| 項目 | 說明 |
|------|------|
| 方法 | Mutation |
| 權限 | Protected |
| 輸入 | { districtId: number } |
| 說明 | 執行風險評估計算 |

回應格式：

```typescript
{
  id: number;
  districtId: number;
  districtName: string;
  riskIndex: number;
  riskLevel: 'low' | 'medium' | 'high' | 'critical';
  reservoirStorageFactor: number;
  rainfallFactor: number;
  irrigationDemandFactor: number;
  recommendation: string;
  assessedAt: Date;
}
```

#### 3.3.4 Water Allocation Router

**waterAllocation.runSimulation**

| 項目 | 說明 |
|------|------|
| 方法 | Mutation |
| 權限 | Protected |
| 說明 | 執行配水模擬 |

輸入參數：

```typescript
{
  scenario: 'normal' | 'drought' | 'flood';
  totalWaterAvailable: number;
  districtIds: number[];
}
```

回應格式：

```typescript
{
  id: number;
  scenario: string;
  totalWaterAvailable: number;
  allocations: {
    districtId: number;
    districtName: string;
    allocatedAmount: number;
    allocationPercentage: number;
    satisfactionRate: number;
  }[];
  efficiency: number;
  simulatedAt: Date;
}
```

---

## 4. 模組設計

### 4.1 前端模組

#### 4.1.1 頁面元件

| 元件名稱 | 檔案路徑 | 說明 |
|---------|---------|------|
| Home | client/src/pages/Home.tsx | 首頁 Landing Page |
| Dashboard | client/src/pages/Dashboard.tsx | 決策儀表板 |
| Reservoirs | client/src/pages/Reservoirs.tsx | 水庫即時監測 |
| RiskAssessment | client/src/pages/RiskAssessment.tsx | 缺水風險評估 |
| WaterAllocation | client/src/pages/WaterAllocation.tsx | 動態配水模擬 |
| MapView | client/src/pages/MapView.tsx | 3D GIS 視覺化 |
| IrrigationDistricts | client/src/pages/IrrigationDistricts.tsx | 灌區管理 |

#### 4.1.2 共用元件

| 元件名稱 | 檔案路徑 | 說明 |
|---------|---------|------|
| DashboardLayout | client/src/components/DashboardLayout.tsx | 儀表板佈局 |
| Map | client/src/components/Map.tsx | Google Maps 整合 |
| ErrorBoundary | client/src/components/ErrorBoundary.tsx | 錯誤邊界 |

### 4.2 後端模組

#### 4.2.1 服務模組

| 模組名稱 | 檔案路徑 | 說明 |
|---------|---------|------|
| apiService | server/services/apiService.ts | 外部 API 整合服務 |
| db | server/db.ts | 資料庫操作服務 |
| routers | server/routers.ts | tRPC 路由定義 |

#### 4.2.2 API 服務類別

```typescript
// apiService.ts 主要類別與方法

class WRAApiService {
  // 水利署開放資料平台 API
  async fetchReservoirDailyOperations(): Promise<ReservoirData[]>
  async fetchReservoirRealtimeData(): Promise<ReservoirData[]>
  async fetchTsengwenReservoir(): Promise<ReservoirData>
  async fetchFeitsui Reservoir(): Promise<ReservoirData>
}

class MOAWeatherApiService {
  // 農業氣象觀測網 API
  async fetchStationInfo(): Promise<StationInfo[]>
  async fetchHourlyRainfall(): Promise<RainfallData[]>
}

class MockDataGenerator {
  // 模擬資料產生器
  generateReservoirs(): ReservoirData[]
  generateRainfallStations(): RainfallStationData[]
  generateIrrigationDistricts(): IrrigationDistrictData[]
  generateIrrigationFacilities(): FacilityData[]
}

// 風險評估計算
function calculateRiskAssessment(params: RiskParams): RiskAssessment

// 配水模擬計算
function runWaterAllocationSimulation(params: SimulationParams): SimulationResult
```

---

## 5. 演算法說明

### 5.1 風險評估演算法

風險指數計算公式：

```
風險指數 = (1 - 水庫蓄水率) × 40 + (1 - 降雨充足度) × 30 + 灌溉需求指數 × 30
```

其中：

| 因子 | 計算方式 | 權重 |
|------|---------|------|
| 水庫蓄水率 | 相關水庫平均蓄水率 | 40% |
| 降雨充足度 | 近期降雨量 / 歷史平均降雨量 | 30% |
| 灌溉需求指數 | 當季作物需水量 / 可供水量 | 30% |

風險等級對應：

| 風險指數範圍 | 風險等級 |
|-------------|---------|
| 0 - 25 | 低風險 (low) |
| 26 - 50 | 中風險 (medium) |
| 51 - 75 | 高風險 (high) |
| 76 - 100 | 極高風險 (critical) |

### 5.2 配水模擬演算法

配水模擬採用比例分配法，根據各灌區面積與作物需水量進行分配：

```typescript
function allocateWater(
  totalWater: number,
  districts: District[],
  scenario: Scenario
): Allocation[] {
  // 計算各灌區需水量
  const demands = districts.map(d => calculateDemand(d, scenario));
  const totalDemand = sum(demands);
  
  // 計算分配比例
  const allocations = districts.map((d, i) => ({
    districtId: d.id,
    allocatedAmount: (demands[i] / totalDemand) * totalWater,
    satisfactionRate: min(1, totalWater / totalDemand)
  }));
  
  return allocations;
}
```

情境調整係數：

| 情境 | 調整係數 |
|------|---------|
| 正常 (normal) | 1.0 |
| 乾旱 (drought) | 0.7 |
| 豪雨 (flood) | 1.3 |

---

## 6. 外部 API 整合

### 6.1 水利署開放資料平台

| API 名稱 | 端點 | 資料格式 |
|---------|------|---------|
| 水庫每日營運狀況 | opendata.wra.gov.tw/api/v2/50C8256D... | JSON |
| 水庫即時水情 | opendata.wra.gov.tw/api/v2/51023e... | JSON |
| 曾文水庫專線 | data5b.wra.gov.tw/api/v2/598befe9... | JSON |
| 翡翠水庫專線 | w3.feitsui.gov.tw/FeitsuiWebService/... | XML/JSON |

### 6.2 農業氣象觀測網

| API 名稱 | 端點 | 資料格式 |
|---------|------|---------|
| 測站資訊 | weather.moa.gov.tw/api/... | JSON |
| 逐時雨量 | weather.moa.gov.tw/api/... | JSON |

### 6.3 資料轉換

外部 API 回應需經過資料轉換才能存入系統：

```typescript
function transformWRAReservoirData(apiResponse: any): ReservoirData {
  return {
    name: apiResponse.ReservoirName || apiResponse.水庫名稱,
    code: apiResponse.ReservoirIdentifier,
    effectiveCapacity: parseFloat(apiResponse.EffectiveCapacity) || 0,
    currentStorage: parseFloat(apiResponse.EffectiveWaterStorageCapacity) || 0,
    storagePercentage: parseFloat(apiResponse.PercentageOfStorage) || 0,
    waterLevel: parseFloat(apiResponse.WaterLevel) || 0,
    inflow: parseFloat(apiResponse.InflowVolume) || 0,
    outflow: parseFloat(apiResponse.OutflowTotal) || 0,
    status: determineStatus(parseFloat(apiResponse.PercentageOfStorage)),
    dataTime: new Date(apiResponse.RecordTime || apiResponse.ObservationTime)
  };
}
```

---

## 7. 錯誤處理

### 7.1 錯誤代碼

| 錯誤代碼 | 說明 |
|---------|------|
| UNAUTHORIZED | 未經授權的存取 |
| FORBIDDEN | 權限不足 |
| NOT_FOUND | 資源不存在 |
| BAD_REQUEST | 請求參數錯誤 |
| INTERNAL_SERVER_ERROR | 伺服器內部錯誤 |
| EXTERNAL_API_ERROR | 外部 API 錯誤 |

### 7.2 錯誤處理策略

| 錯誤類型 | 處理策略 |
|---------|---------|
| 外部 API 逾時 | 重試 3 次，間隔 1 秒 |
| 外部 API 錯誤 | 回傳快取資料或模擬資料 |
| 資料庫連線失敗 | 記錄錯誤並回傳 503 |
| 驗證失敗 | 回傳 401 並導向登入頁 |

---

## 8. 測試規格

### 8.1 測試框架

| 項目 | 工具 |
|------|------|
| 測試框架 | Vitest 2.1.4 |
| 斷言庫 | Vitest 內建 |
| Mock 工具 | Vitest 內建 |

### 8.2 測試檔案

| 測試檔案 | 說明 | 測試案例數 |
|---------|------|-----------|
| auth.logout.test.ts | 認證模組測試 | 1 |
| api.test.ts | API 服務測試 | 18 |
| api-integration.test.ts | API 整合測試 | 17 |

### 8.3 執行測試

```bash
# 執行所有測試
pnpm test

# 執行特定測試檔案
pnpm test server/api.test.ts

# 監看模式
pnpm test --watch
```

---

## 9. 版本歷程

| 版本 | 日期 | 修訂內容 | 修訂者 |
|------|------|---------|--------|
| 1.0 | 2026/01/12 | 初版建立 | JeffLee |

---

**文件結束**
