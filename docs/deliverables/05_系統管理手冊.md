# 系統管理手冊

**農業部農田水利署 115 年度「健全智慧管理模組及大數據資料庫」採購案**

**農業水資源智慧決策支援系統**

---

| 項目 | 內容 |
|------|------|
| 文件編號 | SIDSS-AM-001 |
| 版本 | 1.0 |
| 建立日期 | 2026 年 1 月 12 日 |
| 承辦廠商 | 云昱科技股份有限公司 |

---

## 1. 系統架構

### 1.1 整體架構

農業水資源智慧決策支援系統採用前後端分離架構，主要組成如下：

| 層級 | 技術 | 說明 |
|------|------|------|
| 前端 | React 19 + TypeScript | 使用者介面與互動 |
| 後端 | Node.js 22 + Express + tRPC | API 服務與業務邏輯 |
| 資料庫 | MySQL 8.0 / TiDB | 關聯式資料儲存 |
| 快取 | 記憶體快取 | API 回應快取 |

### 1.2 系統架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                        使用者瀏覽器                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     前端應用程式 (React)                      │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │ Dashboard│ │Reservoir│ │  Risk   │ │   Map   │           │
│  │  Page   │ │  Page   │ │  Page   │ │  Page   │           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   後端 API 服務 (tRPC)                        │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │Dashboard│ │Reservoir│ │  Risk   │ │  Water  │           │
│  │ Router  │ │ Router  │ │ Router  │ │Allocation│          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
└─────────────────────────────────────────────────────────────┘
                    │                    │
                    ▼                    ▼
┌──────────────────────────┐  ┌──────────────────────────────┐
│      資料庫 (MySQL)       │  │       外部 API 服務           │
│  ┌────────────────────┐  │  │  ┌────────────────────────┐  │
│  │ reservoirs         │  │  │  │ 水利署開放資料平台      │  │
│  │ rainfall_stations  │  │  │  │ 農業氣象觀測網         │  │
│  │ irrigation_districts│ │  │  │ 翡翠水庫專線           │  │
│  │ risk_assessments   │  │  │  └────────────────────────┘  │
│  └────────────────────┘  │  └──────────────────────────────┘
└──────────────────────────┘
```

### 1.3 目錄結構

```
agri-water-decision-system/
├── client/                    # 前端應用程式
│   ├── src/
│   │   ├── components/        # 共用元件
│   │   ├── contexts/          # React Context
│   │   ├── hooks/             # 自訂 Hooks
│   │   ├── lib/               # 工具函式
│   │   ├── pages/             # 頁面元件
│   │   ├── App.tsx            # 應用程式進入點
│   │   └── main.tsx           # 主程式
│   └── public/                # 靜態資源
├── server/                    # 後端應用程式
│   ├── _core/                 # 核心框架
│   ├── services/              # 服務模組
│   ├── db.ts                  # 資料庫操作
│   └── routers.ts             # tRPC 路由
├── drizzle/                   # 資料庫 Schema
│   └── schema.ts              # 資料表定義
├── docs/                      # 文件
│   └── deliverables/          # 交付文件
└── shared/                    # 共用程式碼
```

---

## 2. 環境設定

### 2.1 系統需求

| 項目 | 最低需求 | 建議規格 |
|------|---------|---------|
| 作業系統 | Ubuntu 20.04 LTS | Ubuntu 22.04 LTS |
| CPU | 2 核心 | 4 核心以上 |
| 記憶體 | 4 GB | 8 GB 以上 |
| 硬碟空間 | 20 GB | 50 GB 以上 |
| Node.js | 20.x | 22.x |
| MySQL | 8.0 | 8.0 以上 |

### 2.2 環境變數設定

系統需要設定以下環境變數：

| 變數名稱 | 說明 | 範例值 |
|---------|------|--------|
| DATABASE_URL | 資料庫連線字串 | mysql://user:pass@host:3306/db |
| JWT_SECRET | JWT 簽章密鑰 | your-secret-key |
| VITE_APP_ID | OAuth 應用程式 ID | app-id |
| OAUTH_SERVER_URL | OAuth 伺服器網址 | https://oauth.example.com |
| NODE_ENV | 執行環境 | production |

### 2.3 環境變數範例檔案

系統提供 `.env.example` 範例檔案，請複製並修改為 `.env`：

```bash
cp .env.example .env
```

---

## 3. 安裝與部署

### 3.1 安裝步驟

**步驟一：** 安裝 Node.js 22.x

```bash
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
sudo apt-get install -y nodejs
```

**步驟二：** 安裝 pnpm 套件管理器

```bash
npm install -g pnpm
```

**步驟三：** 複製專案程式碼

```bash
git clone https://github.com/guessleej/Smart-Irrigation-DSS.git
cd Smart-Irrigation-DSS
```

**步驟四：** 安裝相依套件

```bash
pnpm install
```

**步驟五：** 設定環境變數

```bash
cp .env.example .env
# 編輯 .env 檔案，填入正確的設定值
```

**步驟六：** 執行資料庫遷移

```bash
pnpm db:push
```

**步驟七：** 建置前端應用程式

```bash
pnpm build
```

**步驟八：** 啟動應用程式

```bash
pnpm start
```

### 3.2 開發模式

若需進行開發或除錯，可使用開發模式啟動：

```bash
pnpm dev
```

開發模式會啟用熱重載（Hot Reload），程式碼變更後會自動重新載入。

### 3.3 Docker 部署（選項）

系統支援 Docker 容器化部署：

```bash
# 建置 Docker 映像檔
docker build -t sidss:latest .

# 執行容器
docker run -d -p 3000:3000 --env-file .env sidss:latest
```

---

## 4. 資料庫管理

### 4.1 資料表結構

系統使用以下資料表：

| 資料表名稱 | 說明 |
|-----------|------|
| users | 使用者帳號資料 |
| reservoirs | 水庫基本資料與即時水情 |
| rainfall_stations | 雨量站基本資料與即時雨量 |
| water_level_stations | 水位站基本資料與即時水位 |
| irrigation_districts | 灌區基本資料 |
| irrigation_facilities | 灌溉設施資料 |
| risk_assessments | 風險評估紀錄 |
| water_allocation_simulations | 配水模擬紀錄 |
| data_sync_logs | 資料同步日誌 |

### 4.2 資料庫遷移

當資料表結構變更時，需執行資料庫遷移：

```bash
# 產生遷移檔案並執行遷移
pnpm db:push
```

### 4.3 資料備份

建議定期備份資料庫：

```bash
# MySQL 備份
mysqldump -u username -p database_name > backup_$(date +%Y%m%d).sql

# 還原備份
mysql -u username -p database_name < backup_20260112.sql
```

### 4.4 資料庫連線設定

若需直接連線資料庫進行管理，請使用以下資訊：

| 項目 | 說明 |
|------|------|
| 主機 | 依環境變數 DATABASE_URL 設定 |
| 連接埠 | 3306（MySQL 預設） |
| 資料庫名稱 | 依環境變數設定 |
| SSL | 建議啟用 SSL 加密連線 |

---

## 5. 使用者管理

### 5.1 角色權限

系統定義兩種使用者角色：

| 角色 | 權限說明 |
|------|---------|
| admin | 系統管理員，可存取所有功能，包含資料管理、系統設定 |
| user | 一般使用者，可查詢資料與執行模擬，但無法修改系統設定 |

### 5.2 設定管理員

首位登入系統的使用者（專案擁有者）會自動設定為管理員。若需手動設定其他使用者為管理員，可透過資料庫直接修改：

```sql
UPDATE users SET role = 'admin' WHERE openId = 'user-open-id';
```

### 5.3 使用者清單查詢

管理員可透過資料庫查詢使用者清單：

```sql
SELECT id, openId, name, email, role, lastSignedIn FROM users;
```

---

## 6. API 管理

### 6.1 外部 API 整合

系統整合以下外部 API：

| API 來源 | 說明 | 更新頻率 |
|---------|------|---------|
| opendata.wra.gov.tw | 水利署開放資料平台 | 每小時 |
| w3.feitsui.gov.tw | 翡翠水庫專線 | 每小時 |
| weather.moa.gov.tw | 農業氣象觀測網 | 每小時 |

### 6.2 API 端點清單

系統提供以下 tRPC API 端點：

| 端點 | 說明 | 權限 |
|------|------|------|
| dashboard.getStats | 取得儀表板統計資料 | public |
| reservoir.list | 取得水庫清單 | public |
| reservoir.getRealtimeData | 取得即時水庫資料 | public |
| riskAssessment.getLatest | 取得最新風險評估 | public |
| riskAssessment.calculate | 執行風險評估 | protected |
| waterAllocation.runSimulation | 執行配水模擬 | protected |
| irrigationDistrict.list | 取得灌區清單 | public |
| irrigationDistrict.create | 新增灌區 | admin |

### 6.3 API 快取設定

系統對外部 API 回應進行快取，以提升效能並減少對外部服務的請求：

| 資料類型 | 快取時間 |
|---------|---------|
| 水庫即時資料 | 5 分鐘 |
| 雨量站資料 | 5 分鐘 |
| 氣象資料 | 10 分鐘 |

---

## 7. 監控與維護

### 7.1 系統健康檢查

可透過以下端點檢查系統健康狀態：

```bash
curl http://localhost:3000/api/health
```

### 7.2 日誌管理

系統日誌儲存於標準輸出（stdout），建議使用日誌管理工具收集：

| 日誌類型 | 說明 |
|---------|------|
| 存取日誌 | 記錄 API 請求與回應 |
| 錯誤日誌 | 記錄系統錯誤與例外 |
| 同步日誌 | 記錄資料同步作業 |

### 7.3 效能監控

建議監控以下指標：

| 指標 | 警戒值 | 說明 |
|------|--------|------|
| CPU 使用率 | > 80% | 考慮擴展資源 |
| 記憶體使用率 | > 85% | 考慮擴展資源 |
| API 回應時間 | > 1000ms | 檢查效能瓶頸 |
| 錯誤率 | > 1% | 檢查系統異常 |

### 7.4 定期維護作業

| 作業項目 | 建議頻率 | 說明 |
|---------|---------|------|
| 資料庫備份 | 每日 | 備份重要資料 |
| 日誌清理 | 每週 | 清理過期日誌 |
| 安全更新 | 每月 | 更新系統套件 |
| 弱點掃描 | 每季 | 執行安全檢測 |

---

## 8. 故障排除

### 8.1 常見問題

**問題：系統無法啟動**

可能原因與解決方案：

| 可能原因 | 解決方案 |
|---------|---------|
| 環境變數未設定 | 檢查 .env 檔案是否完整 |
| 資料庫連線失敗 | 檢查 DATABASE_URL 設定 |
| 連接埠被佔用 | 檢查 3000 連接埠是否可用 |

**問題：外部 API 資料無法取得**

可能原因與解決方案：

| 可能原因 | 解決方案 |
|---------|---------|
| 網路連線問題 | 檢查伺服器網路連線 |
| API 服務中斷 | 等待外部服務恢復 |
| API 格式變更 | 檢查並更新資料轉換邏輯 |

**問題：資料庫查詢緩慢**

可能原因與解決方案：

| 可能原因 | 解決方案 |
|---------|---------|
| 缺少索引 | 新增適當的資料庫索引 |
| 資料量過大 | 考慮資料分區或歸檔 |
| 查詢效率不佳 | 優化 SQL 查詢語句 |

### 8.2 聯絡技術支援

如遇無法解決的問題，請聯繫技術支援團隊：

| 項目 | 內容 |
|------|------|
| 技術支援信箱 | support@yucloud.com.tw |
| 服務時間 | 週一至週五 09:00 - 18:00 |
| 緊急聯絡電話 | +886-2-XXXX-XXXX |

---

## 9. 安全性管理

### 9.1 安全性設定

| 項目 | 設定 |
|------|------|
| HTTPS | 必須啟用 SSL/TLS 加密 |
| JWT 有效期 | 預設 24 小時 |
| Cookie 設定 | HttpOnly, Secure, SameSite=None |

### 9.2 弱點掃描

系統應定期執行弱點掃描，並修補發現的安全漏洞。掃描報告應保存並追蹤修補進度。

### 9.3 存取控制

| 控制項目 | 說明 |
|---------|------|
| 身份驗證 | OAuth 2.0 認證 |
| 授權控制 | 角色型存取控制（RBAC） |
| API 保護 | JWT Token 驗證 |

---

## 10. 版本歷程

| 版本 | 日期 | 修訂內容 | 修訂者 |
|------|------|---------|--------|
| 1.0 | 2026/01/12 | 初版建立 | JeffLee |

---

**文件結束**
