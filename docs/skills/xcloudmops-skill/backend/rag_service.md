# RAG 核心服務後端開發指南

## 1. 服務職責

RAG (Retrieval-Augmented Generation) 核心服務是 xCloudMOPs 的心臟，負責將用戶的查詢與知識庫中的信息相結合，生成高質量的回覆。它的核心職責包括：接收來自接口服務層的請求，執行複雜的檢索與生成流程，並返回最終結果。

## 2. 核心 API 設計

本服務需要暴露以下核心 API 接口，供上層服務（如接口服務層）調用。

### `POST /api/v1/rag/search`

*   **功能**: 執行一次完整的 RAG 檢索和生成流程。
*   **請求體 (Request Body)**:
    ```json
    {
      "knowledge_base_id": "kb-12345",
      "query": "用戶的查詢問題",
      "streaming": true, // 是否以流式傳輸返回結果
      "history": [ // 可選的對話歷史
        {"role": "user", "content": "..."},
        {"role": "assistant", "content": "..."}
      ]
    }
    ```
*   **響應 (Response)**:
    *   如果 `streaming` 為 `true`，則返回一個 Server-Sent Events (SSE) 流，包含中間步驟（如檢索、重排）和最終的生成結果。
    *   如果 `streaming` 為 `false`，則返回一個包含完整答案和來源信息的 JSON 對象。

## 3. 內部工作流

收到 `search` 請求後，服務內部將按順序執行以下工作流，這與架構圖中的「RAG 核心層」緊密對應：

1.  **查詢理解 (Query Understanding)**：對用戶的 `query` 進行分析，判斷其意圖，可能會進行查詢擴展或重寫。

2.  **向量檢索引擎 (Vector Search Engine)**：
    *   根據 `knowledge_base_id`，確定目標向量數據庫（ES/Infinity）。
    *   使用從知識庫設置中獲取的 `Embedding 模型` 將 `query` 轉換為向量。
    *   在向量數據庫中執行相似性搜索，召回初步的候選文檔塊 (chunks)。

3.  **混合搜索策略 (Hybrid Search Strategy)**：
    *   除了向量檢索，還可以結合全文檢索（如 Elasticsearch 的 BM25 算法）來召回更多樣化的結果。
    *   將向量檢索和全文檢索的結果進行合併。

4.  **召回與重排序 (Retrieval & Reranking)**：
    *   將合併後的結果傳遞給 `Reranker 模型`。
    *   Reranker 模型會對候選文檔塊進行重新打分，篩選出與查詢最相關的 top-k 個結果。

5.  **上下文融合 (Context Fusion)**：
    *   將經過重排序的、最相關的文檔塊，與對話歷史 `history`（如果提供）以及原始的 `query` 融合在一起，構建一個內容豐富的 Prompt。

6.  **生成 (Generation)**：
    *   將構建好的 Prompt 發送給指定的 `對話模型`（如 Qwen 2.5 Max, Gemini 等）。
    *   接收語言模型生成的最終答案。

7.  **返回結果**：將最終答案、引用的來源文檔等信息，通過 API 響應返回給調用方。

## 4. 數據庫與模型交互

*   **數據存儲層**：本服務需要與 `MySQL`（獲取知識庫配置，如使用的模型、分塊策略等）、`ES/Infinity`（執行檢索）、`Redis`（緩存檢索結果）進行交互。
*   **模型適配層**：本服務是模型的主要消費者，需要與 `對話模型`、`嵌入模型`、`重排序模型` 進行頻繁的交互。所有模型的調用都應通過統一的「模型適配層」進行，以解耦具體的模型實現。

## 5. 錯誤處理與日誌

*   **錯誤處理**：在工作流的每一步都應有明確的錯誤處理機制。例如，如果向量數據庫檢索失敗，應記錄詳細錯誤並向上層返回一個標準的錯誤響應。
*   **日誌記錄**：在關鍵步驟（如接收請求、檢索到的文檔、構建的 Prompt、LLM 返回的結果）都應記錄詳細的日誌，以便於問題追蹤和性能分析。日誌應發送到統一的日誌記錄基礎設施中。
